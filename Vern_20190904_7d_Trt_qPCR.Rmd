---
title: "Vern_2019_7d_Trt_qPCR"
output: html_document
---

# Load the packages
```{r, message=FALSE}
library(readxl)
library(dplyr)
library(plyr)
library(reshape2)
```


# Load the data from excel
```{r}
Raw_data <- read_excel("C:/Users/Po-Kai/Box Sync/Runcie_lab/Vernalization_project/Vernalization_project_PKH_part/qPCR_data/2019_project/20190904.xlsx", 
    sheet = "Raw_data", col_types = c("text", 
        "text", "numeric", "skip", "skip", 
        "skip", "skip", "skip", "skip"))

#
#UBC <- read_excel("C:/Users/Po-Kai/Box Sync/Runcie_lab/Vernalization project/Vernalization_project_PKH_part/qPCR_data/2019_project/20190904.xlsx", sheet = "UBC")

#FT <- read_excel("C:/Users/Po-Kai/Box Sync/Runcie_lab/Vernalization project/Vernalization_project_PKH_part/qPCR_data/2019_project/20190904.xlsx", sheet = "FT")


```


# dCT and fold change
```{r}
#summary_Raw <- ddply(Raw_data, c("Sample_Name","Target_Name"), summarise, mean = mean(CT, na.rm=TRUE))

summary_Raw <- ddply(Raw_data, c("Sample_Name","Target_Name"), summarise,
      mean = mean(CT, na.rm=TRUE), sd = sd(CT, na.rm=TRUE))


FT_UBC <- dcast(summary_Raw, formula = Sample_Name ~ Target_Name, value.var = "mean")
FT_UBC$dCT <- FT_UBC$FT - FT_UBC$UBC
FT_UBC$fold_change <- 2^(-(FT_UBC$dCT))

# Add the leaf rank
FT_UBC$leaf_rank <- factor(c("5", "10", "15", "20"), level=c("5", "10", "15", "20"))
```


# Biological replicate
```{r}
dCT_final <- ddply(FT_UBC, c("leaf_rank"), summarise,
      mean = mean(fold_change, na.rm=TRUE), sd = sd(fold_change, na.rm=TRUE))

#ddply(FT_UBC %>% select(c("Sample_Name","dCT","leaf_rank")), c("leaf_rank"), summarise,
#      mean = mean(dCT, na.rm=TRUE), sd = sd(dCT, na.rm=TRUE))


p <- ggplot(dCT_final, aes(x=leaf_rank, y=mean, fill=leaf_rank)) + 
   geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9))

p + scale_fill_brewer(palette="Paired") + theme_minimal() + labs(x = "Leaf rank", y = "Relative expression to UBC")


```


# Comparing to the "BioGroup Analysis Result" generated by QuantStudio
```{r}
# UBC mean + SD
ddply(FT_UBC, c("leaf_rank"), summarise,
      mean = mean(UBC, na.rm=TRUE), sd = sd(UBC, na.rm=TRUE))

# FT mean + SD
ddply(FT_UBC, c("leaf_rank"), summarise,
      mean = mean(FT, na.rm=TRUE), sd = sd(FT, na.rm=TRUE))


# SD of 5th leaf
sqrt(0.2217058^2 + 1.0787067^2)

sqrt(0.1165115	^2 + 0.7167852^2)
```
QuantStudio pools all the CT from 3 biological replicates and gets the average of UBC and FT separately (called "Ct Mean"). Then, the "Delta Ct Mean" is calculated by (CT_Mean_FT)-(CT_Mean_UBC). I can reproduce the "Ct Mean" and so do the "Delta Ct Mean". 2 of the numbers are slight different from those from QuantStudio, and I guess that is because te QuantStudio did not omit 2 of the tech-rep results. 

However, I have no idea how QuantStudio calculates "Delta Ct SD". Not squrt(s1^2 + s2^2).


```{r}
# Check where is the boundary of each individual plant:
FT_UBC$leaf_rankN = as.numeric(as.character(FT_UBC$leaf_rank))
which(diff(FT_UBC$leaf_rankN)< 0)
FT_UBC$Sample = c(rep(1,4),rep(2,4),rep(3,4))

# Convert the "Sample" to factor:
FT_UBC$Sample = factor(FT_UBC$Sample)
ggplot(FT_UBC,aes(x=leaf_rankN,y=fold_change)) + geom_point(aes(color = Sample)) + geom_smooth(aes(color=Sample,group = Sample),method='loess',span=.5)

ggplot(FT_UBC,aes(x=leaf_rankN,y=fold_change)) + geom_point(aes(color = Sample)) + geom_smooth(aes(color=Sample,group = Sample),method='loess')

ggplot(FT_UBC,aes(x=leaf_rankN,y=fold_change)) + geom_point(aes(color = Sample)) + geom_smooth(aes(color=Sample,group = Sample))


# Can we pool the data together? Something like:
ggplot(FT_UBC,aes(x=leaf_rankN,y=fold_change)) + geom_point(aes(color = Sample)) + geom_smooth(method='loess',span=.5)
```
